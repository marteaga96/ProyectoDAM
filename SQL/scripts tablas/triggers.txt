--TRIGGER TABLA USUARIOS

CREATE TRIGGER trg_insertarEnRoles
ON USUARIOS
AFTER INSERT
AS
BEGIN
    INSERT INTO ROLES (ID_USUARIO, NOMBRE_SESION)
    SELECT ID_USUARIO, NOMBRE_SESION
    FROM inserted; -- 'inserted' es una tabla temporal que contiene los datos reci√©n insertados
END;




--TRIGGER TABLA COMPRAS
CREATE TRIGGER trg_comprobarDatosProducto
ON COMPRAS
INSTEAD OF INSERT
AS
BEGIN
    DECLARE @ID_PROVEEDOR INT;
    DECLARE @ID_PRODUCTO INT;
    DECLARE @NOMBRE_PROVEEDOR VARCHAR(25);
    DECLARE @NOMBRE_PRODUCTO VARCHAR(35);

    SELECT @ID_PROVEEDOR = ID_PROVEEDOR,
           @ID_PRODUCTO = ID_PRODUCTO,
           @NOMBRE_PROVEEDOR = NOMBRE_PROVEEDOR,
           @NOMBRE_PRODUCTO = NOMBRE_PRODUCTO
    FROM inserted;

    -- Comprobar que el NOMBRE_PROVEEDOR coincide con el ID_PROVEEDOR
    IF NOT EXISTS (SELECT 1 FROM PROVEEDOR WHERE ID_PROVEEDOR = @ID_PROVEEDOR AND NOMBRE_PROVEEDOR = @NOMBRE_PROVEEDOR)
    BEGIN
        RAISERROR('El NOMBRE_PROVEEDOR no coincide con el ID_PROVEEDOR.', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END

    -- Comprobar que el NOMBRE_PRODUCTO coincide con el ID_PRODUCTO
    IF NOT EXISTS (SELECT 1 FROM PRODUCTOS WHERE ID_PRODUCTO = @ID_PRODUCTO AND NOMBRE_PRODUCTO = @NOMBRE_PRODUCTO)
    BEGIN
        RAISERROR('El NOMBRE_PRODUCTO no coincide con el ID_PRODUCTO.', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END

    -- Si las comprobaciones son correctas, insertar el registro
    INSERT INTO COMPRAS (ID_PROVEEDOR, APROBADO_POR, NOMBRE_PROVEEDOR, ID_PRODUCTO, NOMBRE_PRODUCTO, CANTIDAD_COMPRA_PRODUCTO, FECHA)
    SELECT ID_PROVEEDOR, APROBADO_POR, NOMBRE_PROVEEDOR, ID_PRODUCTO, NOMBRE_PRODUCTO, CANTIDAD_COMPRA_PRODUCTO, FECHA
    FROM inserted;
END;
